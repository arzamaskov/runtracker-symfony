server {
    listen 80;
    server_name localhost;
    
    root /var/www;
    index index.html;

    # Backend API
    location /api {
        alias /app/backend/public;
        try_files $uri @backend;
    }

    location @backend {
        rewrite ^/api(/.*)$ /index.php$1 last;
        rewrite ^/api$ /index.php last;
    }

    location ~ ^/index\.php(/|$) {
        root /app/backend/public;
        
        fastcgi_pass php:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        
        fastcgi_param SCRIPT_FILENAME /var/www/backend/public/index.php;
        fastcgi_param DOCUMENT_ROOT /var/www/backend/public;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        internal;
    }

    # Vite dev server - special paths
    location ~ ^/(node_modules|@vite|@fs|@id|src|\.svelte-kit)/ {
        proxy_pass http://frontend:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend - proxy to Vite dev server (catch-all for everything else)
    location / {
        proxy_pass http://frontend:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}
